import logging
from pathlib import Path
from unittest.mock import MagicMock, PropertyMock

import pandas as pd
import pytest
from hydromt.model import ModelRoot

from hydromt_fiat import FIATModel
from hydromt_fiat.components import VulnerabilityComponent
from hydromt_fiat.components.vulnerability import VulnerabilityData
from hydromt_fiat.utils import (
    CURVE,
    CURVES,
    EXPOSURE_LINK,
    VULNERABILITY,
    VULNERABILITY_FILE,
)


def test_vulnerability_data_errors():
    # Construct an empty data container
    x = VulnerabilityData(pd.DataFrame(), pd.DataFrame())

    # Error on wrong get
    with pytest.raises(
        KeyError,
        match="Can't get 'foo'",
    ):
        _ = x["foo"]

    # Error on wrong set
    with pytest.raises(
        KeyError,
        match="Can't set 'foo' in VulnerabilityData class",
    ):
        x["foo"] = 2


def test_vulnerability_component_empty(
    mock_model: MagicMock,
):
    # Setup the component
    component = VulnerabilityComponent(model=mock_model)

    # Assert the content
    assert component._filename == f"{VULNERABILITY}/{CURVES}.csv"
    assert component.data.curves.empty
    assert isinstance(component.data, VulnerabilityData)


def test_vulnerability_component_clear(
    mock_model: MagicMock,
    vulnerability_curves: pd.DataFrame,
):
    # Setup the component
    component = VulnerabilityComponent(model=mock_model)

    # Set data like a dummy
    component._data = VulnerabilityData(vulnerability_curves, pd.DataFrame())
    # Assert the current state
    assert len(component.data.curves) == 1001

    # Call the clear method
    component.clear()
    # Assert the state after
    assert len(component.data.curves) == 0


def test_vulnerability_component_set(
    caplog: pytest.LogCaptureFixture,
    mock_model: MagicMock,
    vulnerability_curves: pd.DataFrame,
):
    caplog.set_level(logging.WARNING)
    # Setup the component
    component = VulnerabilityComponent(model=mock_model)
    # Assert current state
    assert component.data.curves.empty

    # Call the method
    component.set(vulnerability_curves, name=CURVES)
    # Assert the state
    assert not component.data.curves.empty

    # Overwrite and trigger warning
    component.set(vulnerability_curves, name=CURVES)
    # Assert the warning
    assert "Replacing vulnerabilty data: curves" in caplog.text


def test_vulnerability_component_read(
    mock_model_config: MagicMock,
    model_data_clipped_path: Path,
):
    type(mock_model_config).root = PropertyMock(
        side_effect=lambda: ModelRoot(model_data_clipped_path, mode="r"),
    )
    # Setup the component
    component = VulnerabilityComponent(model=mock_model_config)

    # Read by calling the data property, thereby falling back on the config entry
    # As there is a config entry present
    component.data

    # Assert the state
    assert not component.data.curves.empty
    assert not component.data.identifiers.empty
    assert len(component.data.identifiers.columns) == 5
    assert not any(
        (component.data.identifiers[EXPOSURE_LINK] == component.data.identifiers[CURVE])
    )


def test_vulnerability_component_read_sig(
    mock_model_config: MagicMock,
    model_data_clipped_path: Path,
):
    type(mock_model_config).root = PropertyMock(
        side_effect=lambda: ModelRoot(model_data_clipped_path, mode="r"),
    )
    # Setup the component
    component = VulnerabilityComponent(model=mock_model_config)

    # Read with argument
    component.read(f"{VULNERABILITY}/{CURVES}.csv")

    # Assert the state
    assert not component.data.curves.empty
    assert not component.data.identifiers.empty


def test_vulnerability_component_read_no_id(
    tmp_path: Path,
    mock_model_config: MagicMock,
    vulnerability_curves_only_path: Path,
):
    type(mock_model_config).root = PropertyMock(
        side_effect=lambda: ModelRoot(tmp_path, mode="r"),
    )
    # Setup the component
    component = VulnerabilityComponent(model=mock_model_config)

    # Read with from the tmp dir where no identifiers are present
    component.read(f"{CURVES}.csv")

    # Assert the state
    assert not component.data.curves.empty
    assert not component.data.identifiers.empty
    assert len(component.data.identifiers.columns) == 4
    assert all(
        (component.data.identifiers[EXPOSURE_LINK] == component.data.identifiers[CURVE])
    )


def test_vulnerability_component_write(
    tmp_path: Path,
    mock_model_config: MagicMock,
    vulnerability_curves: pd.DataFrame,
):
    # Setup the component
    component = VulnerabilityComponent(model=mock_model_config)

    # Set data like a dummy
    component.data[CURVES] = vulnerability_curves

    # Write the data
    component.write()

    # Assert the output
    assert Path(tmp_path, VULNERABILITY, f"{CURVES}.csv").is_file()
    # Assert the config
    assert component.model.config.get(VULNERABILITY_FILE) == Path(
        tmp_path,
        VULNERABILITY,
        f"{CURVES}.csv",
    )


def test_vulnerability_component_write_empty(
    caplog: pytest.LogCaptureFixture,
    mock_model: MagicMock,
):
    caplog.set_level(logging.INFO)
    # Setup the component
    component = VulnerabilityComponent(model=mock_model)

    # Write the data
    component.write()

    # Assert the logging
    assert "No vulnerability curves encountered, skipping.." in caplog.text


def test_vulnerability_component_write_sig(
    tmp_path: Path,
    mock_model_config: MagicMock,
    vulnerability_curves: pd.DataFrame,
):
    # Setup the component
    component = VulnerabilityComponent(model=mock_model_config)

    # Set data like a dummy
    component.data[CURVES] = vulnerability_curves

    # Write the data
    component.write("foo.csv", index=False)

    # Assert the output
    assert Path(tmp_path, "foo.csv").is_file()
    # Assert the config
    assert component.model.config.get(VULNERABILITY_FILE) == Path(
        tmp_path,
        "foo.csv",
    )


def test_vulnerability_component_setup(model: FIATModel):
    # Setup the component
    component = VulnerabilityComponent(model=model)

    # Assert it's empty
    assert component.data.curves.empty

    # Setup the vulnerability
    component.setup(
        vulnerability_fname="jrc_curves",
        vulnerability_linking_fname="jrc_curves_link",
        continent="europe",
    )

    assert not component.data.curves.empty
    assert not component.data.identifiers.empty
